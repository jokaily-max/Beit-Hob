<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Pool Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #lockScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #lockScreen.hidden { display: none; }

        .lock-box {
            background: white;
            border-radius: 12px;
            padding: 40px 36px;
            width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .lock-box .lock-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .lock-box h2 {
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 22px;
        }

        .lock-box p {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 24px;
        }

        .lock-box input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 14px;
            transition: border-color 0.2s;
            text-align: center;
            letter-spacing: 3px;
        }

        .lock-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .lock-box button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .lock-box button:hover { background: #2980b9; }

        .lock-error {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }

        .github-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: 600;
        }

        .github-status.synced { background: #d5f5e3; color: #27ae60; }
        .github-status.saving { background: #fef9e7; color: #f39c12; }
        .github-status.error  { background: #fadbd8; color: #e74c3c; }
        .github-status.offline { background: #ecf0f1; color: #7f8c8d; }

        #appContent { display: none; }
        #appContent.visible { display: block; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-box {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .summary-box.highlight {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }
        
        .summary-box h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .summary-box .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
        
        .controls button.secondary {
            background: #95a5a6;
        }
        
        .controls button.secondary:hover {
            background: #7f8c8d;
        }

        .controls button.whatsapp-notify {
            background: #25D366;
        }

        .controls button.whatsapp-notify:hover {
            background: #1da851;
        }
        
        table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-collapse: collapse;
        }
        
        th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status.paid {
            background: #2ecc71;
            color: white;
        }
        
        .status.partial {
            background: #f39c12;
            color: white;
        }
        
        .status.unpaid {
            background: #e74c3c;
            color: white;
        }
        
        .status.overpaid {
            background: #9b59b6;
            color: white;
        }
        
        input[type="number"] {
            width: 80px;
            padding: 6px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .debt-info {
            font-size: 12px;
            color: #e74c3c;
            font-weight: bold;
            margin-top: 4px;
        }
        
        .overpaid-info {
            font-size: 12px;
            color: #9b59b6;
            font-weight: bold;
            margin-top: 4px;
        }
        
        .next-recipient {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .week-selector {
            margin: 15px 0;
        }
        
        .week-selector label {
            margin-right: 10px;
            font-weight: bold;
        }
        
        .week-selector select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
            font-size: 14px;
        }

        .entrant-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s;
        }

        .entrant-item:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        .entrant-item.dragging {
            opacity: 0.5;
            border-color: #3498db;
        }

        .entrant-item.drag-over {
            border-top: 3px solid #3498db;
        }

        .drag-handle {
            font-size: 18px;
            color: #95a5a6;
            margin-right: 10px;
            cursor: move;
        }

        .entrant-number {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
            min-width: 30px;
            text-align: center;
        }

        .entrant-name-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        .entrant-name-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .remove-entrant {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }

        .remove-entrant:hover {
            background: #c0392b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0;
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .payout-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .payout-card.pending {
            border-left: 4px solid #f39c12;
        }

        .payout-card.paid {
            border-left: 4px solid #27ae60;
        }

        .payout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .payout-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .payout-status {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .payout-status.pending {
            background: #f39c12;
            color: white;
        }

        .payout-status.paid {
            background: #27ae60;
            color: white;
        }

        .payout-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .payout-detail {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .payout-detail label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .payout-detail input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        .payout-actions {
            display: flex;
            gap: 10px;
        }

        .summary-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-row {
            display: grid;
            grid-template-columns: 50px 2fr 1fr 1fr 1fr 1.5fr;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
        }

        .summary-row.header {
            background: #34495e;
            color: white;
            font-weight: bold;
            font-size: 13px;
        }

        .summary-row:hover:not(.header) {
            background: #f8f9fa;
        }

        .projection {
            font-size: 12px;
            color: #7f8c8d;
        }

        .transaction-log {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            display: grid;
            grid-template-columns: 150px 100px 2fr 1fr 1fr 80px;
            gap: 15px;
            align-items: center;
        }

        .transaction-item:hover {
            background: #f8f9fa;
        }

        .transaction-item.received {
            border-left: 4px solid #27ae60;
        }

        .transaction-item.paid {
            border-left: 4px solid #e74c3c;
        }

        .transaction-date {
            font-size: 12px;
            color: #7f8c8d;
        }

        .transaction-type {
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 3px;
            background: #ecf0f1;
            display: inline-block;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 16px;
        }

        .transaction-amount.positive {
            color: #27ae60;
        }

        .transaction-amount.negative {
            color: #e74c3c;
        }

        .date-badge {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .transaction-actions {
            display: flex;
            gap: 5px;
        }

        .transaction-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
        }

        .transaction-actions button.edit {
            background: #3498db;
        }

        .transaction-actions button.delete {
            background: #e74c3c;
        }

        .expense-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .expense-form h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .expense-form .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .expense-form .form-group {
            display: flex;
            flex-direction: column;
        }

        .expense-form label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .expense-form input, .expense-form select, .expense-form textarea {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .expense-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .expense-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .expense-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #ecf0f1;
        }

        .expense-list-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .expense-item {
            display: grid;
            grid-template-columns: 140px 90px 100px 1fr 130px 80px;
            gap: 12px;
            padding: 14px 20px;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
        }

        .expense-item:hover {
            background: #f8f9fa;
        }

        .expense-item.beit-hob-expense {
            border-left: 4px solid #e74c3c;
        }

        .expense-item.investment-expense {
            border-left: 4px solid #9b59b6;
        }

        .expense-item.pool-expense {
            border-left: 4px solid #3498db;
        }

        .expense-item-header {
            display: grid;
            grid-template-columns: 140px 90px 100px 1fr 130px 80px;
            gap: 12px;
            padding: 10px 20px;
            background: #34495e;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .cashbox-tag {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            display: inline-block;
        }

        .cashbox-tag.beit-hob { background: #e74c3c; }
        .cashbox-tag.investment { background: #9b59b6; }
        .cashbox-tag.pool { background: #3498db; }

        .sort-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sort-controls button {
            padding: 5px 12px;
            font-size: 12px;
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
        }

        .sort-controls button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .rate-settings-box {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .profile-section {
            margin-top: 8px;
            background: #f0f4f8;
            border-radius: 4px;
            padding: 10px 12px;
            border-left: 3px solid #3498db;
            display: none;
        }
        .profile-section.open { display: block; }
        .profile-toggle {
            background: none;
            border: none;
            color: #3498db;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 0;
            font-weight: 600;
            margin-top: 4px;
        }
        .profile-row {
            display: flex;
            gap: 8px;
            margin-bottom: 7px;
            align-items: center;
            flex-wrap: wrap;
        }
        .profile-row label {
            font-size: 12px;
            color: #555;
            font-weight: 600;
            min-width: 110px;
        }
        .profile-row input[type="number"] {
            width: 75px;
            padding: 5px 7px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-size: 13px;
        }
        .profile-row select {
            padding: 5px 7px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-size: 13px;
        }
        .split-hint {
            font-size: 11px;
            color: #7f8c8d;
            margin-left: 4px;
        }
        .deleted-badge {
            background: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 6px;
            font-weight: bold;
        }
        .pool-group-men { color: #2980b9; font-weight: bold; }
        .pool-group-women { color: #8e44ad; font-weight: bold; }

        .rate-settings-box label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .rate-settings-box input {
            padding: 7px 10px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 15px;
            width: 120px;
            font-weight: bold;
            color: #2c3e50;
        }

        .rate-note {
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>

    <!-- Lock Screen -->
    <div id="lockScreen">
        <div class="lock-box">
            <div class="lock-icon">üîí</div>
            <h2>Beit Hob Tracker</h2>
            <p>Enter your password to continue</p>
            <input type="password" id="lockPassword" placeholder="Password"
                   onkeydown="if(event.key==='Enter') attemptUnlock()">
            <button onclick="attemptUnlock()">Unlock</button>
            <div class="lock-error" id="lockError">Incorrect password. Try again.</div>
            <div id="firstTimeSetup" style="display:none; margin-top:18px; border-top:1px solid #ecf0f1; padding-top:18px; text-align:left;">
                <p style="font-size:12px; color:#7f8c8d; margin-bottom:10px;">First time setup ‚Äî set your password:</p>
                <input type="password" id="newPassword" placeholder="New password"
                       style="margin-bottom:8px; letter-spacing:1px;" onkeydown="">
                <input type="password" id="confirmPassword" placeholder="Confirm password"
                       style="margin-bottom:8px; letter-spacing:1px;">
                <button onclick="setFirstPassword()" style="background:#27ae60;">Set Password & Enter</button>
                <div id="setupError" class="lock-error"></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until unlocked) -->
    <div id="appContent">
    <div class="header">
        <h1>üí∞ Money Pool Tracker <span id="githubStatus" class="github-status offline">‚ö™ Not configured</span></h1>
        <div class="date-badge">üìÖ Today: <span id="currentDate"></span></div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('payments')">üíµ Payments</button>
            <button class="tab-button" onclick="switchTab('summary')">üìä Summary</button>
            <button class="tab-button" onclick="switchTab('payouts')">üí∏ Pool Payouts</button>
            <button class="tab-button" onclick="switchTab('transactions')">üìù Transaction Log</button>
            <button class="tab-button" onclick="switchTab('expenses')">üßæ Expenses</button>
            <button class="tab-button" onclick="switchTab('investments')">üìà Investments</button>
            <button class="tab-button" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="summary">
            <div class="summary-box">
                <h3>Investment Cash Box</h3>
                <div class="value" id="investmentTotal">$0</div>
            </div>
            <div class="summary-box">
                <h3>Beit Hob Cash Box</h3>
                <div class="value" id="beitHobTotal">$0</div>
            </div>
            <div class="summary-box highlight">
                <h3>Next Men's Pool Recipient</h3>
                <div class="value" id="nextRecipient">-</div>
            </div>
            <div class="summary-box highlight" style="border-left-color: #8e44ad; background: #f5eef8;">
                <h3>Next Women's Pool Recipient</h3>
                <div class="value" id="nextRecipientWomen" style="color:#8e44ad;">-</div>
            </div>
            <div class="summary-box">
                <h3>Total Outstanding Debt</h3>
                <div class="value" id="totalDebt">$0</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="week-selector">
            <label for="weekSelect">Current Week:</label>
            <select id="weekSelect"></select>
            <button onclick="addNewWeek()" style="margin-left: 10px;">Add New Week</button>
        </div>
        <div style="margin-top: 15px;">
            <button onclick="showManageEntrants()">üë• Manage People</button>
            <button onclick="showWhatsAppSettings()">üì± WhatsApp Settings</button>
            <button onclick="notifyDuePayments()" class="whatsapp-notify">üì¢ Notify This Week's Payers</button>
            <button onclick="saveData()">üíæ Save Data</button>
            <button onclick="exportToExcel()">üìä Export Full Report (Excel)</button>
            <button onclick="exportTransactionsToExcel()" style="background: #16a085;">üìä Export Transactions (Excel)</button>
            <button onclick="exportToFile()">üì§ Export to File</button>
            <button onclick="importFromFile()" class="secondary">üì• Import from File</button>
            <button onclick="clearAllData()" class="secondary">üóëÔ∏è Clear All</button>
        </div>
        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
    </div>

    <div id="paymentsTab" class="tab-content active">
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; color: #2c3e50;">Contribution Rates (per person)</h3>
                <div>
                    <button onclick="sortPaymentsTable('number')" style="padding: 6px 12px; margin-right: 5px;">Sort by #</button>
                    <button onclick="sortPaymentsTable('name')" style="padding: 6px 12px;">Sort by Name</button>
                </div>
            </div>
            <div id="rateBreakdownBox" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
        </div>
        
        <table id="mainTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Weekly Payment</th>
                    <th>Monthly Payment</th>
                    <th>Full Month</th>
                    <th>Status</th>
                    <th>Balance Info</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <div id="summaryTab" class="tab-content">
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">Individual Summary</h2>
                <div>
                    <button onclick="sortSummaryTable('number')" style="padding: 6px 12px; margin-right: 5px;">Sort by #</button>
                    <button onclick="sortSummaryTable('name')" style="padding: 6px 12px;">Sort by Name</button>
                </div>
            </div>
        </div>
        <div class="summary-table">
            <div class="summary-row header">
                <div>#</div>
                <div>Name</div>
                <div>Total Paid</div>
                <div>Balance</div>
                <div>Status</div>
                <div>Payout Projection</div>
            </div>
            <div id="summaryTableBody"></div>
        </div>
    </div>

    <div id="payoutsTab" class="tab-content">
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="margin-bottom: 15px;">Pool Payout History</h2>
            <div id="payoutsContainer"></div>
        </div>
    </div>

    <div id="transactionsTab" class="tab-content">
        <div class="transaction-log">
            <h2 style="margin-bottom: 20px;">üìù Transaction Log</h2>
            <div id="transactionsList"></div>
        </div>
    </div>

    <!-- Expenses Tab -->
    <div id="expensesTab" class="tab-content">
        <div class="expense-form">
            <h3>üßæ Record New Expense</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Cash Box</label>
                    <select id="expCashBox">
                        <option value="beit-hob">Beit Hob</option>
                        <option value="pool">Pool</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="expCurrency" onchange="updateExpenseAmountLabel()">
                        <option value="USD">USD ($)</option>
                        <option value="LBP">LBP (ŸÑ.ŸÑ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="expAmountLabel">Amount (USD)</label>
                    <input type="number" id="expAmount" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="expDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Description</label>
                    <input type="text" id="expDescription" placeholder="What was this expense for?">
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <button onclick="addExpense()" style="background:#e74c3c; color:white; border:none; padding:10px 22px; border-radius:4px; cursor:pointer; font-size:14px;">‚ûï Add Expense</button>
                <span id="expEditNote" style="font-size:12px; color:#7f8c8d; display:none;">Editing entry ‚Äî <a href="#" onclick="cancelExpenseEdit(); return false;">Cancel</a></span>
            </div>
        </div>

        <div class="expense-list">
            <div class="expense-list-header">
                <h3>All Expenses</h3>
                <div class="sort-controls">
                    <span style="font-size:12px; color:#7f8c8d; align-self:center;">Sort:</span>
                    <button id="expSortDate" class="active" onclick="setExpenseSort('date')">üïê Date</button>
                    <button id="expSortDesc" onclick="setExpenseSort('desc')">A-Z Desc</button>
                    <button id="expSortAmount" onclick="setExpenseSort('amount')">üí≤ Amount</button>
                    <button id="expSortBox" onclick="setExpenseSort('box')">üì¶ Cash Box</button>
                </div>
            </div>
            <div class="expense-item-header">
                <div>Date</div>
                <div>Amount (USD)</div>
                <div>Cash Box</div>
                <div>Description</div>
                <div>Original Amount</div>
                <div>Actions</div>
            </div>
            <div id="expensesList"></div>
        </div>
    </div>

    <!-- Investments Tab -->
    <div id="investmentsTab" class="tab-content">
        <div class="expense-form">
            <h3>üìà Record New Investment</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Currency</label>
                    <select id="invCurrency" onchange="updateInvestmentAmountLabel()">
                        <option value="USD">USD ($)</option>
                        <option value="LBP">LBP (ŸÑ.ŸÑ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="invAmountLabel">Amount (USD)</label>
                    <input type="number" id="invAmount" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="invDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Description / Investment Name</label>
                    <input type="text" id="invDescription" placeholder="Describe this investment...">
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <button onclick="addInvestment()" style="background:#9b59b6; color:white; border:none; padding:10px 22px; border-radius:4px; cursor:pointer; font-size:14px;">‚ûï Add Investment</button>
                <span id="invEditNote" style="font-size:12px; color:#7f8c8d; display:none;">Editing entry ‚Äî <a href="#" onclick="cancelInvestmentEdit(); return false;">Cancel</a></span>
            </div>
        </div>

        <div class="expense-list">
            <div class="expense-list-header">
                <h3>All Investments</h3>
                <div class="sort-controls">
                    <span style="font-size:12px; color:#7f8c8d; align-self:center;">Sort:</span>
                    <button id="invSortDate" class="active" onclick="setInvestmentSort('date')">üïê Date</button>
                    <button id="invSortDesc" onclick="setInvestmentSort('desc')">A-Z Desc</button>
                    <button id="invSortAmount" onclick="setInvestmentSort('amount')">üí≤ Amount</button>
                </div>
            </div>
            <div class="expense-item-header" style="grid-template-columns: 140px 90px 1fr 130px 80px;">
                <div>Date</div>
                <div>Amount (USD)</div>
                <div>Description</div>
                <div>Original Amount</div>
                <div>Actions</div>
            </div>
            <div id="investmentsList"></div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content">
        <div style="display:flex; flex-direction:column; gap:20px; max-width:560px;">

            <!-- Exchange Rate -->
            <div style="background:white; padding:25px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom:18px; color:#2c3e50;">üí± Exchange Rate</h2>
                <p style="font-size:13px; color:#7f8c8d; margin-bottom:12px;">
                    Set the USD to LBP rate. Used for new entries only ‚Äî existing entries keep their original rate.
                </p>
                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <label style="font-weight:600; font-size:15px;">1 USD =</label>
                    <input type="number" id="exchangeRateInput" min="1" step="0.5"
                           style="width:130px; padding:9px; border:2px solid #3498db; border-radius:4px; font-size:16px; font-weight:bold;">
                    <label style="font-weight:600; font-size:15px;">LBP</label>
                    <button onclick="saveExchangeRate()" style="background:#27ae60; color:white; border:none; padding:10px 18px; border-radius:4px; cursor:pointer; font-size:14px;">üíæ Save Rate</button>
                </div>
                <div id="rateSavedMsg" style="margin-top:8px; font-size:12px; color:#27ae60; display:none;">‚úì Rate saved!</div>
                <p style="margin-top:12px; font-size:15px; font-weight:bold; color:#3498db;">Current: 1 USD = <span id="currentRateDisplay">89,500</span> LBP</p>
            </div>

            <!-- GitHub Sync -->
            <div style="background:white; padding:25px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom:6px; color:#2c3e50;">üîÑ GitHub Auto-Sync</h2>
                <p style="font-size:13px; color:#7f8c8d; margin-bottom:16px;">
                    Your token is stored only in this browser ‚Äî never in the HTML file or the repo. You need to enter it once per device.
                </p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <div>
                        <label style="font-size:12px; color:#7f8c8d; font-weight:600; display:block; margin-bottom:4px;">GitHub Personal Access Token</label>
                        <input type="password" id="ghTokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                               style="width:100%; padding:9px; border:1px solid #bdc3c7; border-radius:4px; font-size:14px; font-family:monospace;">
                    </div>
                    <p style="font-size:11px; color:#95a5a6;">
                        Create at: GitHub ‚Üí Settings ‚Üí Developer Settings ‚Üí Personal Access Tokens (classic) ‚Üí check <strong>repo</strong> scope.
                    </p>
                    <button onclick="saveGithubToken()" style="background:#2c3e50; color:white; border:none; padding:10px 18px; border-radius:4px; cursor:pointer; font-size:14px; align-self:flex-start;">
                        üíæ Save Token
                    </button>
                    <div id="tokenSavedMsg" style="font-size:12px; color:#27ae60; display:none;">‚úì Token saved! Syncing now...</div>
                    <div id="tokenClearBtn" style="display:none;">
                        <button onclick="clearGithubToken()" style="background:#e74c3c; color:white; border:none; padding:7px 14px; border-radius:4px; cursor:pointer; font-size:12px;">
                            üóëÔ∏è Remove Saved Token
                        </button>
                    </div>
                </div>
            </div>

            <!-- Change Password -->
            <div style="background:white; padding:25px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom:6px; color:#2c3e50;">üîë Change Password</h2>
                <p style="font-size:13px; color:#7f8c8d; margin-bottom:16px;">Update the password used to unlock this app.</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <input type="password" id="currentPwInput" placeholder="Current password"
                           style="padding:9px; border:1px solid #bdc3c7; border-radius:4px; font-size:14px;">
                    <input type="password" id="newPwInput" placeholder="New password"
                           style="padding:9px; border:1px solid #bdc3c7; border-radius:4px; font-size:14px;">
                    <input type="password" id="confirmPwInput" placeholder="Confirm new password"
                           style="padding:9px; border:1px solid #bdc3c7; border-radius:4px; font-size:14px;">
                    <button onclick="changePassword()" style="background:#8e44ad; color:white; border:none; padding:10px 18px; border-radius:4px; cursor:pointer; font-size:14px; align-self:flex-start;">
                        üîë Update Password
                    </button>
                    <div id="pwChangeMsg" style="font-size:12px; display:none;"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Manage Entrants Modal -->
    <div id="manageModal" class="modal">
        <div class="modal-content" style="max-width: 680px;">
            <span class="close-modal" onclick="closeModal('manageModal')">&times;</span>
            <h2>Manage People</h2>
            <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 15px;">
                Drag to reorder ‚Ä¢ Edit name inline ‚Ä¢ Click ‚ñ∂ Rates to set contribution profile ‚Ä¢ Click √ó to remove
            </p>
            <div id="entrantsList" style="max-height: 520px; overflow-y: auto;"></div>
            <button onclick="addNewEntrant()" style="margin-top: 15px;">‚ûï Add Person</button>
            <button onclick="saveEntrantsAndClose()" style="margin-left: 10px; background: #27ae60;">‚úì Save Changes</button>
        </div>
    </div>

    <!-- WhatsApp Settings Modal -->
    <div id="whatsappModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="closeModal('whatsappModal')">&times;</span>
            <h2>üì± WhatsApp Settings</h2>
            <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 15px;">
                Enter phone numbers with country code (e.g., +1234567890). Set default for wa.me links in phone settings to use regular WhatsApp.
            </p>
            <div id="whatsappList" style="max-height: 400px; overflow-y: auto;"></div>
            <button onclick="saveWhatsAppSettings()" style="margin-top: 15px; background: #27ae60;">‚úì Save Numbers</button>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="closeModal('editTransactionModal')">&times;</span>
            <h2>Edit Transaction</h2>
            <div id="editTransactionContent"></div>
        </div>
    </div>

    </div><!-- end appContent -->

    <script>
        // ‚îÄ‚îÄ‚îÄ GitHub Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const GITHUB_REPO  = 'jokaily-max/Beit-Hob';
        const GITHUB_FILE  = 'Beit-Hob/data.json';
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // ‚îÄ‚îÄ‚îÄ People ‚Äî each person: { id, name, profile, deletedAt } ‚îÄ‚îÄ
        // profile: { weeklyAmount, monthlyAmount, monthlyToInvestment, monthlyToBeitHob, poolGroup }
        let people = [];          // active + deleted people (never purged)
        let peopleOrder = [];     // array of IDs in display order (active only)
        let _nextPersonSeq = 1;   // ever-incrementing, never reused
        let deletedPeopleIds = new Set(); // retired IDs

        // Legacy fallback (will be migrated on load)
        let entrants = [];

        let weeks = [];           // week.payments is now { [personId]: {thursday,monthly,fullMonth} }
                                  // week.rateSnapshots is { [personId]: {weeklyAmount,...} }
        let currentWeekIndex = 0;
        let poolRecipientIndex = 0;       // men's pool
        let poolRecipientIndexWomen = 0;  // women's pool
        let payouts = [];
        let currentTab = 'payments';
        let displayOrder = [];
        let phoneNumbers = {};    // keyed by person ID
        let paymentHistory = [];
        let payoutHistory = [];
        let paymentsSortMode = 'number';
        let summarySortMode = 'number';

        let expenseEntries = [];
        let investmentEntries = [];
        let exchangeRate = 89500;
        let expenseSortMode = 'date';
        let investmentSortMode = 'date';
        let editingExpenseId = null;
        let editingInvestmentId = null;

        let _ghFileSha = null;

        // ‚îÄ‚îÄ‚îÄ Person helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generatePersonId() {
            const id = `p_${_nextPersonSeq}`;
            _nextPersonSeq++;
            return id;
        }

        function getActivePeople() {
            return peopleOrder.map(id => people.find(p => p.id === id)).filter(Boolean);
        }

        function getPersonById(id) {
            return people.find(p => p.id === id) || null;
        }

        function defaultProfile(poolGroup = 'men') {
            if (poolGroup === 'women') {
                return { weeklyAmount: 10, monthlyAmount: 30, monthlyToInvestment: 25, monthlyToBeitHob: 5, poolGroup: 'women' };
            }
            return { weeklyAmount: 15, monthlyAmount: 50, monthlyToInvestment: 35, monthlyToBeitHob: 15, poolGroup: 'men' };
        }

        // Get rate snapshot for a person in a given week (falls back to current profile)
        function getRatesForWeek(personId, weekIndex) {
            const week = weeks[weekIndex];
            if (week && week.rateSnapshots && week.rateSnapshots[personId]) {
                return week.rateSnapshots[personId];
            }
            const person = getPersonById(personId);
            return person ? { ...person.profile } : defaultProfile();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOCK / AUTH
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function getStoredHash() {
            return localStorage.getItem('bh_pwHash');
        }

        async function hashPassword(pw) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        async function attemptUnlock() {
            const pw = document.getElementById('lockPassword').value;
            if (!pw) return;
            const stored = getStoredHash();
            if (!stored) {
                // No password set yet ‚Äî show setup form
                document.getElementById('firstTimeSetup').style.display = 'block';
                document.getElementById('lockError').style.display = 'none';
                return;
            }
            const hash = await hashPassword(pw);
            if (hash === stored) {
                unlockApp();
            } else {
                document.getElementById('lockError').style.display = 'block';
                document.getElementById('lockPassword').value = '';
                document.getElementById('lockPassword').focus();
            }
        }

        async function setFirstPassword() {
            const np = document.getElementById('newPassword').value;
            const cp = document.getElementById('confirmPassword').value;
            const err = document.getElementById('setupError');
            if (!np || np.length < 4) { err.textContent = 'Password must be at least 4 characters.'; err.style.display = 'block'; return; }
            if (np !== cp)            { err.textContent = 'Passwords do not match.';                  err.style.display = 'block'; return; }
            const hash = await hashPassword(np);
            localStorage.setItem('bh_pwHash', hash);
            unlockApp();
        }

        function unlockApp() {
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('appContent').classList.add('visible');
            init();
        }

        // On page load ‚Äî check if password is set
        window.addEventListener('load', () => {
            const stored = getStoredHash();
            if (!stored) {
                // First time ‚Äî show setup immediately
                document.getElementById('firstTimeSetup').style.display = 'block';
            }
            document.getElementById('lockPassword').focus();
        });

        async function changePassword() {
            const current = document.getElementById('currentPwInput').value;
            const np      = document.getElementById('newPwInput').value;
            const cp      = document.getElementById('confirmPwInput').value;
            const msg     = document.getElementById('pwChangeMsg');

            const currentHash = await hashPassword(current);
            if (currentHash !== getStoredHash()) {
                msg.textContent = '‚úó Current password is incorrect.';
                msg.style.color = '#e74c3c';
                msg.style.display = 'block';
                return;
            }
            if (!np || np.length < 4) {
                msg.textContent = '‚úó New password must be at least 4 characters.';
                msg.style.color = '#e74c3c';
                msg.style.display = 'block';
                return;
            }
            if (np !== cp) {
                msg.textContent = '‚úó New passwords do not match.';
                msg.style.color = '#e74c3c';
                msg.style.display = 'block';
                return;
            }
            const hash = await hashPassword(np);
            localStorage.setItem('bh_pwHash', hash);
            document.getElementById('currentPwInput').value = '';
            document.getElementById('newPwInput').value = '';
            document.getElementById('confirmPwInput').value = '';
            msg.textContent = '‚úì Password updated successfully!';
            msg.style.color = '#27ae60';
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GITHUB SYNC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function getGhToken() {
            return localStorage.getItem('bh_ghToken') || '';
        }

        function saveGithubToken() {
            const token = document.getElementById('ghTokenInput').value.trim();
            if (!token) { alert('Please paste your GitHub token.'); return; }
            localStorage.setItem('bh_ghToken', token);
            document.getElementById('ghTokenInput').value = '';
            document.getElementById('tokenSavedMsg').style.display = 'block';
            document.getElementById('tokenClearBtn').style.display = 'block';
            setTimeout(() => { document.getElementById('tokenSavedMsg').style.display = 'none'; }, 3000);
            setGhStatus('saving', '‚è≥ Syncing...');
            loadFromGithub();
        }

        function clearGithubToken() {
            if (!confirm('Remove saved GitHub token from this device?')) return;
            localStorage.removeItem('bh_ghToken');
            document.getElementById('tokenClearBtn').style.display = 'none';
            setGhStatus('offline', '‚ö™ Not configured');
        }

        function setGhStatus(type, text) {
            const el = document.getElementById('githubStatus');
            el.className = `github-status ${type}`;
            el.textContent = text;
        }

        async function loadFromGithub() {
            const token = getGhToken();
            if (!token) { setGhStatus('offline', '‚ö™ Not configured'); return; }

            setGhStatus('saving', '‚è≥ Loading...');
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (res.status === 404) {
                    // File doesn't exist yet ‚Äî that's fine, we'll create it on first save
                    setGhStatus('synced', '‚úì Ready (new file)');
                    return;
                }
                if (!res.ok) throw new Error(`GitHub API ${res.status}`);
                const file = await res.json();
                _ghFileSha = file.sha;
                const data = JSON.parse(atob(file.content.replace(/\n/g, '')));
                applyData(data);
                // Also cache locally
                localStorage.setItem('moneyPoolData', JSON.stringify(data));
                refreshAllViews();
                setGhStatus('synced', '‚úì Synced');
            } catch (e) {
                console.error('GitHub load error:', e);
                setGhStatus('error', '‚úó Sync error');
            }
        }

        async function saveToGithub(data) {
            const token = getGhToken();
            if (!token) return; // no token, skip silently

            setGhStatus('saving', '‚è≥ Saving...');
            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const body = {
                    message: `Auto-save ${new Date().toLocaleString()}`,
                    content,
                    ..._ghFileSha ? { sha: _ghFileSha } : {}
                };
                const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error(`GitHub API ${res.status}`);
                const result = await res.json();
                _ghFileSha = result.content.sha;
                setGhStatus('synced', '‚úì Synced');
            } catch (e) {
                console.error('GitHub save error:', e);
                setGhStatus('error', '‚úó Save failed');
            }
        }

        function applyData(data) {
            // ‚îÄ‚îÄ New format ‚îÄ‚îÄ
            if (data.people && Array.isArray(data.people)) {
                people               = data.people.map(p => ({ joinedWeekIndex: 0, ...p })); // default joinedWeekIndex
                peopleOrder          = data.peopleOrder          || people.filter(p=>!p.deletedAt).map(p=>p.id);
                _nextPersonSeq       = data._nextPersonSeq       || (people.length + 1);
                deletedPeopleIds     = new Set(data.deletedPeopleIds || []);
                weeks                = data.weeks                || [];
                currentWeekIndex     = data.currentWeekIndex     || 0;
                poolRecipientIndex   = data.poolRecipientIndex   || 0;
                poolRecipientIndexWomen = data.poolRecipientIndexWomen || 0;
                payouts              = data.payouts              || [];
                phoneNumbers         = data.phoneNumbers         || {};
                paymentHistory       = data.paymentHistory       || [];
                payoutHistory        = data.payoutHistory        || [];
                expenseEntries       = data.expenseEntries       || [];
                investmentEntries    = data.investmentEntries    || [];
                exchangeRate         = data.exchangeRate         || 89500;
                return;
            }

            // ‚îÄ‚îÄ Legacy migration: old format had entrants[] array ‚îÄ‚îÄ
            const legacyEntrants = data.entrants || [];
            people = [];
            peopleOrder = [];
            _nextPersonSeq = 1;
            deletedPeopleIds = new Set();

            legacyEntrants.forEach((name, idx) => {
                const id = generatePersonId();
                people.push({
                    id,
                    name,
                    profile: defaultProfile('men'),
                    deletedAt: null,
                    joinedWeekIndex: 0
                });
                peopleOrder.push(id);
                // Migrate phone numbers from index ‚Üí id
                if (data.phoneNumbers && data.phoneNumbers[idx] !== undefined) {
                    phoneNumbers[id] = data.phoneNumbers[idx];
                }
            });

            // Migrate weeks: payments array ‚Üí keyed object, add rate snapshots
            weeks = (data.weeks || []).map(week => {
                const newPayments = {};
                const newSnapshots = {};
                peopleOrder.forEach((id, idx) => {
                    const oldPayment = week.payments && week.payments[idx];
                    newPayments[id] = oldPayment
                        ? { thursday: oldPayment.thursday||0, monthly: oldPayment.monthly||0, fullMonth: oldPayment.fullMonth||0 }
                        : { thursday: 0, monthly: 0, fullMonth: 0 };
                    const person = getPersonById(id);
                    newSnapshots[id] = person ? { ...person.profile } : defaultProfile();
                });
                return { ...week, payments: newPayments, rateSnapshots: newSnapshots };
            });

            currentWeekIndex        = data.currentWeekIndex     || 0;
            poolRecipientIndex      = data.poolRecipientIndex    || 0;
            poolRecipientIndexWomen = 0;
            payouts                 = data.payouts               || [];
            paymentHistory          = (data.paymentHistory || []).map(p => {
                // migrate entrantIndex ‚Üí entrantId
                if (!p.entrantId && p.entrantIndex !== undefined) {
                    const id = peopleOrder[p.entrantIndex];
                    return { ...p, entrantId: id || null };
                }
                return p;
            });
            payoutHistory           = (data.payoutHistory || []).map(p => {
                if (!p.recipientId && p.recipientIndex !== undefined) {
                    const id = peopleOrder[p.recipientIndex];
                    return { ...p, recipientId: id || null };
                }
                return p;
            });
            expenseEntries          = data.expenseEntries        || [];
            investmentEntries       = data.investmentEntries     || [];
            exchangeRate            = data.exchangeRate          || 89500;
            phoneNumbers            = {};  // already migrated above in forEach
            // re-do phone migration cleanly
            if (data.phoneNumbers) {
                legacyEntrants.forEach((_, idx) => {
                    const id = peopleOrder[idx];
                    if (id && data.phoneNumbers[idx]) {
                        phoneNumbers[id] = data.phoneNumbers[idx];
                    }
                });
            }
        }

        function refreshAllViews() {
            populateWeekSelector();
            renderTable();
            updateSummary();
            renderSummaryTab();
            renderPayoutsTab();
            renderTransactionLog();
            renderExpensesList();
            renderInvestmentsList();
            if (document.getElementById('exchangeRateInput'))
                document.getElementById('exchangeRateInput').value = exchangeRate;
            if (document.getElementById('currentRateDisplay'))
                document.getElementById('currentRateDisplay').textContent = exchangeRate.toLocaleString();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function init() {
            await loadData();
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000);

            // If no people at all, seed with default 20 for backwards compat
            if (people.length === 0 && peopleOrder.length === 0) {
                for (let i = 1; i <= 20; i++) {
                    const id = generatePersonId();
                    people.push({ id, name: `Person ${i}`, profile: defaultProfile('men'), deletedAt: null, joinedWeekIndex: 0 });
                    peopleOrder.push(id);
                }
            }

            if (weeks.length === 0) addNewWeek();
            populateWeekSelector();
            renderTable();
            updateSummary();
            renderSummaryTab();
            renderPayoutsTab();
            renderTransactionLog();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expDate').value = today;
            document.getElementById('invDate').value = today;
            document.getElementById('exchangeRateInput').value = exchangeRate;
            document.getElementById('currentRateDisplay').textContent = exchangeRate.toLocaleString();
            renderExpensesList();
            renderInvestmentsList();

            if (getGhToken()) document.getElementById('tokenClearBtn').style.display = 'block';
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDate').textContent = now.toLocaleString('en-US', options);
        }

        function getTodayInfo() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const dayOfMonth = today.getDate();
            
            return {
                date: today,
                isThursday: dayOfWeek === 4,
                isFifthOfMonth: dayOfMonth === 5,
                dayOfWeek: dayOfWeek,
                dayOfMonth: dayOfMonth
            };
        }

        function getWhoOwesThisWeek() {
            return getActivePeople().filter(person => {
                const id = person.id;
                const totalPaid = weeks.reduce((s,w) => s+(w.payments[id]?.thursday||0)+(w.payments[id]?.monthly||0)+(w.payments[id]?.fullMonth||0),0);
                let expectedWeekly=0, expectedMonthly=0;
                for (let i=0; i<=currentWeekIndex; i++) {
                    const r = getRatesForWeek(id, i);
                    expectedWeekly += r.weeklyAmount||0;
                    if (isMonthlyPaymentDue(weeks[i]?.date)) expectedMonthly += r.monthlyAmount||0;
                }
                return totalPaid < (expectedWeekly + expectedMonthly);
            }).map(person => {
                const id = person.id;
                const totalPaid = weeks.reduce((s,w) => s+(w.payments[id]?.thursday||0)+(w.payments[id]?.monthly||0)+(w.payments[id]?.fullMonth||0),0);
                let expectedWeekly=0, expectedMonthly=0;
                for (let i=0; i<=currentWeekIndex; i++) {
                    const r = getRatesForWeek(id, i);
                    expectedWeekly += r.weeklyAmount||0;
                    if (isMonthlyPaymentDue(weeks[i]?.date)) expectedMonthly += r.monthlyAmount||0;
                }
                return { id, name: person.name, totalOwed: Math.abs(totalPaid - (expectedWeekly+expectedMonthly)) };
            });
        }

        function notifyDuePayments() {
            const owingList = getWhoOwesThisWeek();
            if (owingList.length === 0) { alert('No one has payments due this week!'); return; }
            let message = `Found ${owingList.length} people with payments due:\n\n`;
            owingList.forEach(p => { message += `${p.name}: $${p.totalOwed.toFixed(2)}\n`; });
            message += '\nSend WhatsApp notifications?';
            if (!confirm(message)) return;
            let sent = 0;
            owingList.forEach(person => {
                if (!phoneNumbers[person.id]) { alert(`No phone number for ${person.name}. Skipping.`); return; }
                const msg = `Hi ${person.name}!\n\nYou currently have an outstanding balance of $${person.totalOwed.toFixed(2)}.\n\nPlease make your payment when convenient. Thank you!`;
                const phone = phoneNumbers[person.id].replace(/[^0-9]/g, '');
                setTimeout(() => window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank'), sent * 1000);
                sent++;
            });
            alert(`Opening WhatsApp for ${sent} notifications...`);
        }

        function showWhatsAppSettings() {
            const container = document.getElementById('whatsappList');
            container.innerHTML = '';
            getActivePeople().forEach((person, idx) => {
                const div = document.createElement('div');
                div.style.cssText = 'background:#f8f9fa; padding:12px; margin-bottom:8px; border-radius:4px; display:flex; align-items:center; gap:10px;';
                div.innerHTML = `
                    <div style="flex:0 0 40px; font-weight:bold; color:#7f8c8d;">${idx+1}</div>
                    <div style="flex:1; font-weight:bold;">${person.name} <span style="font-size:10px; color:#95a5a6;">${person.id}</span></div>
                    <input type="tel" id="phone_${person.id}" value="${phoneNumbers[person.id]||''}"
                           placeholder="+1234567890"
                           style="flex:1; padding:6px; border:1px solid #ddd; border-radius:3px;">`;
                container.appendChild(div);
            });
            document.getElementById('whatsappModal').style.display = 'block';
        }

        function saveWhatsAppSettings() {
            getActivePeople().forEach(person => {
                const phone = document.getElementById(`phone_${person.id}`)?.value?.trim();
                if (phone) phoneNumbers[person.id] = phone;
                else delete phoneNumbers[person.id];
            });
            saveData();
            closeModal('whatsappModal');
            alert('WhatsApp numbers saved!');
        }

        function sendWhatsAppNotification(personId, amount) {
            const phone = phoneNumbers[personId];
            if (!phone) { alert('No phone number set for this person. Go to WhatsApp Settings to add it.'); return; }
            const person = getPersonById(personId);
            const name = person ? person.name : personId;
            const msg = `Hi ${name}! Your payment of $${amount.toFixed(2)} has been recorded. Thank you!`;
            window.open(`https://wa.me/${phone.replace(/[^0-9]/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'payments') {
                document.getElementById('paymentsTab').classList.add('active');
                document.querySelector('.controls').style.display = 'block';
            } else if (tabName === 'summary') {
                document.getElementById('summaryTab').classList.add('active');
                document.querySelector('.controls').style.display = 'none';
                renderSummaryTab();
            } else if (tabName === 'payouts') {
                document.getElementById('payoutsTab').classList.add('active');
                document.querySelector('.controls').style.display = 'none';
                renderPayoutsTab();
            } else if (tabName === 'transactions') {
                document.getElementById('transactionsTab').classList.add('active');
                document.querySelector('.controls').style.display = 'none';
                renderTransactionLog();
            } else if (tabName === 'expenses') {
                document.getElementById('expensesTab').classList.add('active');
                document.querySelector('.controls').style.display = 'none';
                renderExpensesList();
            } else if (tabName === 'investments') {
                document.getElementById('investmentsTab').classList.add('active');
                document.querySelector('.controls').style.display = 'none';
                renderInvestmentsList();
            } else if (tabName === 'settings') {
                document.getElementById('settingsTab').classList.add('active');
                document.querySelector('.controls').style.display = 'none';
                document.getElementById('exchangeRateInput').value = exchangeRate;
                document.getElementById('currentRateDisplay').textContent = exchangeRate.toLocaleString();
            }
        }

        function addNewWeek() {
            const weekDate = weeks.length === 0 ? new Date() : new Date(weeks[weeks.length - 1].date);
            if (weeks.length > 0) weekDate.setDate(weekDate.getDate() + 7);

            const payments = {};
            const rateSnapshots = {};
            getActivePeople().forEach(person => {
                payments[person.id] = { thursday: 0, monthly: 0, fullMonth: 0 };
                rateSnapshots[person.id] = { ...person.profile }; // snapshot current rates
            });

            weeks.push({
                date: weekDate.toISOString().split('T')[0],
                payments,
                rateSnapshots
            });

            currentWeekIndex = weeks.length - 1;
            populateWeekSelector();
            renderTable();
            updateSummary();
            saveData();
        }

        function populateWeekSelector() {
            const select = document.getElementById('weekSelect');
            select.innerHTML = '';
            weeks.forEach((week, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Week of ${formatDate(week.date)}`;
                select.appendChild(option);
            });
            select.value = currentWeekIndex;
            select.onchange = (e) => {
                currentWeekIndex = parseInt(e.target.value);
                renderTable();
                updateSummary();
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateMMDDYYYY(date) {
            const d = new Date(date);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const year = d.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function isMonthlyPaymentDue(weekDate) {
            const date = new Date(weekDate);
            const dayOfMonth = date.getDate();
            const weekEnd = new Date(date);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            return (dayOfMonth <= 5 && 5 <= weekEnd.getDate()) || 
                   (date.getMonth() !== weekEnd.getMonth() && weekEnd.getDate() >= 5);
        }

        function sortPaymentsTable(mode) {
            paymentsSortMode = mode;
            renderTable();
        }

        function sortSummaryTable(mode) {
            summarySortMode = mode;
            renderSummaryTab();
        }

        function getNextPaymentInfo(personId) {
            const person = getPersonById(personId);
            const joinedAt = person?.joinedWeekIndex ?? 0;

            const totalThursday  = weeks.reduce((s,w) => s + (w.payments[personId]?.thursday  || 0), 0);
            const totalMonthly   = weeks.reduce((s,w) => s + (w.payments[personId]?.monthly   || 0), 0);
            const totalFullMonth = weeks.reduce((s,w) => s + (w.payments[personId]?.fullMonth || 0), 0);
            const totalPaid = totalThursday + totalMonthly + totalFullMonth;

            // Expected: only from the week they joined onwards
            let expectedWeekly = 0, expectedMonthly = 0;
            for (let i = joinedAt; i <= currentWeekIndex; i++) {
                const rates = getRatesForWeek(personId, i);
                expectedWeekly += rates.weeklyAmount || 0;
                if (isMonthlyPaymentDue(weeks[i].date)) {
                    expectedMonthly += rates.monthlyAmount || 0;
                }
            }
            const expectedTotal = expectedWeekly + expectedMonthly;
            const balance = totalPaid - expectedTotal;

            let nextPaymentDate = new Date(weeks[currentWeekIndex].date);
            let nextPaymentAmount = 0;

            if (balance >= 0) {
                let remainingBalance = balance;
                for (let i = currentWeekIndex + 1; i < currentWeekIndex + 52; i++) {
                    const futureDate = new Date(weeks[currentWeekIndex].date);
                    futureDate.setDate(futureDate.getDate() + (7 * (i - currentWeekIndex)));
                    const futureDateStr = futureDate.toISOString().split('T')[0];
                    const currentRates = person ? person.profile : defaultProfile();
                    let weekCost = currentRates.weeklyAmount || 0;
                    if (isMonthlyPaymentDue(futureDateStr)) weekCost += (currentRates.monthlyAmount || 0);
                    if (remainingBalance >= weekCost) {
                        remainingBalance -= weekCost;
                    } else {
                        nextPaymentDate = futureDate;
                        nextPaymentAmount = weekCost - remainingBalance;
                        break;
                    }
                }
            } else {
                const currentDay = nextPaymentDate.getDay();
                const daysToThursday = (4 - currentDay + 7) % 7;
                nextPaymentDate.setDate(nextPaymentDate.getDate() + daysToThursday);
                nextPaymentAmount = Math.abs(balance);
            }

            return { date: nextPaymentDate, amount: nextPaymentAmount, isOwed: balance < 0, balance };
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const currentWeek = weeks[currentWeekIndex];
            if (!currentWeek) return;
            const monthlyDue = isMonthlyPaymentDue(currentWeek.date);

            let activePeople = getActivePeople();
            if (paymentsSortMode === 'name') {
                activePeople = [...activePeople].sort((a, b) => a.name.localeCompare(b.name));
            }

            // Render rate breakdown box
            const rateBox = document.getElementById('rateBreakdownBox');
            if (rateBox) {
                const groups = {};
                activePeople.forEach(p => {
                    const g = p.profile.poolGroup || 'men';
                    if (!groups[g]) groups[g] = p.profile;
                });
                rateBox.innerHTML = '';
                Object.entries(groups).forEach(([group, profile]) => {
                    const color = group === 'women' ? '#8e44ad' : '#2980b9';
                    rateBox.innerHTML += `
                        <div style="background:#ecf0f1; padding:10px; border-radius:4px; border-left:3px solid ${color};">
                            <div style="font-size:11px; color:${color}; font-weight:bold; text-transform:uppercase; margin-bottom:4px;">${group}</div>
                            <div style="font-size:13px; color:#2c3e50;">Weekly: <strong>$${profile.weeklyAmount}</strong></div>
                            <div style="font-size:13px; color:#2c3e50;">Monthly: <strong>$${profile.monthlyAmount}</strong> ($${profile.monthlyToInvestment} inv + $${profile.monthlyToBeitHob} bh)</div>
                        </div>`;
                });
            }

            // Determine next recipients per pool group
            const menIds = peopleOrder.filter(id => { const p=getPersonById(id); return p && !p.deletedAt && p.profile.poolGroup !== 'women'; });
            const womenIds = peopleOrder.filter(id => { const p=getPersonById(id); return p && !p.deletedAt && p.profile.poolGroup === 'women'; });
            const nextMenId   = menIds[poolRecipientIndex % Math.max(menIds.length, 1)];
            const nextWomenId = womenIds[poolRecipientIndexWomen % Math.max(womenIds.length, 1)];

            activePeople.forEach((person, displayIdx) => {
                const id = person.id;
                const payment = currentWeek.payments[id] || { thursday: 0, monthly: 0, fullMonth: 0 };
                const rates = getRatesForWeek(id, currentWeekIndex);

                const totalThursday  = weeks.reduce((s,w) => s + (w.payments[id]?.thursday  || 0), 0);
                const totalMonthly   = weeks.reduce((s,w) => s + (w.payments[id]?.monthly   || 0), 0);
                const totalFullMonth = weeks.reduce((s,w) => s + (w.payments[id]?.fullMonth || 0), 0);
                const totalPaid = totalThursday + totalMonthly + totalFullMonth;

                let expectedWeekly = 0, expectedMonthly = 0;
                const joinedAt = person.joinedWeekIndex ?? 0;
                for (let i = joinedAt; i <= currentWeekIndex; i++) {
                    const r = getRatesForWeek(id, i);
                    expectedWeekly += r.weeklyAmount || 0;
                    if (isMonthlyPaymentDue(weeks[i].date)) expectedMonthly += r.monthlyAmount || 0;
                }
                const expectedTotal = expectedWeekly + expectedMonthly;
                const totalBalance = totalPaid - expectedTotal;
                const nextPayment = getNextPaymentInfo(id);

                let status = '', statusClass = '';
                if (totalBalance >= 0) {
                    const nd = nextPayment.date.toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
                    status = `COVERED ‚Üí ${nd}`;
                    statusClass = 'paid';
                } else if (totalBalance < 0 && totalPaid > 0) {
                    status = 'PARTIAL'; statusClass = 'partial';
                } else {
                    status = 'UNPAID'; statusClass = 'unpaid';
                }

                const isNextMen   = id === nextMenId;
                const isNextWomen = id === nextWomenId;
                const groupColor  = person.profile.poolGroup === 'women' ? '#8e44ad' : '#2980b9';

                const row = document.createElement('tr');
                if (isNextMen || isNextWomen) row.classList.add('next-recipient');

                row.innerHTML = `
                    <td>
                        <strong style="color:${groupColor};">${displayIdx + 1}</strong>
                        <div style="font-size:10px; color:${groupColor};">${person.profile.poolGroup || 'men'}</div>
                    </td>
                    <td>
                        <strong>${person.name}</strong>
                        <div style="font-size:10px; color:#7f8c8d;">ID: ${id}</div>
                        ${isNextMen ? '<span style="font-size:10px; background:#f39c12; color:white; padding:1px 5px; border-radius:3px;">‚≠ê Next (Men)</span>' : ''}
                        ${isNextWomen ? '<span style="font-size:10px; background:#8e44ad; color:white; padding:1px 5px; border-radius:3px;">‚≠ê Next (Women)</span>' : ''}
                    </td>
                    <td>
                        <input type="number"
                               value="${payment.thursday || 0}"
                               onchange="updatePayment('${id}', 'thursday', this.value)"
                               min="0" step="0.01">
                        <div style="font-size:10px; color:#7f8c8d;">Rate: $${rates.weeklyAmount}</div>
                    </td>
                    <td>
                        <input type="number"
                               value="${payment.monthly || 0}"
                               onchange="updatePayment('${id}', 'monthly', this.value)"
                               min="0" step="0.01"
                               ${!monthlyDue ? 'style="background:#ecf0f1;"' : ''}>
                        <div style="font-size:10px; color:#7f8c8d;">${monthlyDue ? `Rate: $${rates.monthlyAmount}` : 'Not due'}</div>
                    </td>
                    <td>
                        <input type="number"
                               value="${payment.fullMonth || 0}"
                               onchange="updatePayment('${id}', 'fullMonth', this.value)"
                               min="0" step="0.01"
                               placeholder="${(rates.weeklyAmount*4 + rates.monthlyAmount).toFixed(0)}">
                        <div style="font-size:10px; color:#7f8c8d;">Covers 4wk+monthly</div>
                    </td>
                    <td><span class="status ${statusClass}">${status}</span></td>
                    <td>
                        ${totalBalance < 0 ? `
                            <div class="debt-info">Owes: $${Math.abs(totalBalance).toFixed(2)}</div>
                            <div style="font-size:11px; color:#e74c3c; margin-top:3px;">Due now: $${nextPayment.amount.toFixed(2)}</div>
                        ` : `
                            <div style="color:#27ae60; font-weight:bold; font-size:12px;">‚úì Covered</div>
                            <div style="font-size:11px; color:#7f8c8d; margin-top:3px;">Next: $${nextPayment.amount.toFixed(2)} on ${nextPayment.date.toLocaleDateString('en-GB', {day:'2-digit', month:'short'})}</div>
                        `}
                    </td>`;
                tbody.appendChild(row);
            });
        }

        function updatePayment(personId, type, value) {
            const amount = parseFloat(value) || 0;
            if (!weeks[currentWeekIndex].payments[personId]) {
                weeks[currentWeekIndex].payments[personId] = { thursday: 0, monthly: 0, fullMonth: 0 };
            }
            const oldAmount = weeks[currentWeekIndex].payments[personId][type] || 0;
            weeks[currentWeekIndex].payments[personId][type] = amount;

            if (amount > oldAmount) {
                const increase = amount - oldAmount;
                const person = getPersonById(personId);
                const name = person ? person.name : personId;

                paymentHistory.push({
                    id: Date.now() + Math.random(),
                    entrantId: personId,
                    entrantName: name,
                    amount: increase,
                    type,
                    direction: 'received',
                    weekDate: weeks[currentWeekIndex].date,
                    timestamp: new Date().toISOString()
                });

                if (phoneNumbers[personId]) {
                    if (confirm(`Payment of $${increase.toFixed(2)} recorded for ${name}. Send WhatsApp notification?`)) {
                        sendWhatsAppNotification(personId, increase);
                    }
                }
            }

            renderTable();
            updateSummary();
            renderTransactionLog();
            saveData();
        }

        function updateSummary() {
            let investmentTotal = 0, beitHobTotal = 0, poolMenTotal = 0, poolWomenTotal = 0;

            weeks.forEach(week => {
                getActivePeople().forEach(person => {
                    const id = person.id;
                    const payment = week.payments[id] || {};
                    const rates = week.rateSnapshots?.[id] || person.profile;
                    const monthly = payment.monthly || 0;
                    const fullMonth = payment.fullMonth || 0;
                    const weekly = payment.thursday || 0;
                    const isWomen = rates.poolGroup === 'women';

                    // Monthly split
                    if (monthly > 0) {
                        const ratio = rates.monthlyAmount > 0 ? monthly / rates.monthlyAmount : 1;
                        investmentTotal += rates.monthlyToInvestment * ratio;
                        beitHobTotal    += rates.monthlyToBeitHob    * ratio;
                    }

                    // Full month: first monthlyAmount goes to investment/beitHob split, rest to pool
                    if (fullMonth > 0) {
                        const monthPart = Math.min(fullMonth, rates.monthlyAmount || 0);
                        const weeklyPart = fullMonth - monthPart;
                        if (monthPart > 0 && rates.monthlyAmount > 0) {
                            const ratio = monthPart / rates.monthlyAmount;
                            investmentTotal += rates.monthlyToInvestment * ratio;
                            beitHobTotal    += rates.monthlyToBeitHob    * ratio;
                        }
                        if (weeklyPart > 0) {
                            isWomen ? (poolWomenTotal += weeklyPart) : (poolMenTotal += weeklyPart);
                        }
                    }

                    // Weekly
                    isWomen ? (poolWomenTotal += weekly) : (poolMenTotal += weekly);
                });
            });

            // Subtract expenses
            expenseEntries.forEach(exp => {
                if (exp.cashBox === 'beit-hob') beitHobTotal -= exp.amountUSD;
                else if (exp.cashBox === 'pool') poolMenTotal -= exp.amountUSD;
                else if (exp.cashBox === 'pool-women') poolWomenTotal -= exp.amountUSD;
            });
            investmentEntries.forEach(inv => { investmentTotal -= inv.amountUSD; });
            payoutHistory.forEach(p => {
                const person = getPersonById(p.recipientId);
                const isWomen = person?.profile?.poolGroup === 'women';
                isWomen ? (poolWomenTotal -= p.amount) : (poolMenTotal -= p.amount);
            });

            document.getElementById('investmentTotal').textContent = `$${investmentTotal.toFixed(2)}`;
            document.getElementById('beitHobTotal').textContent    = `$${beitHobTotal.toFixed(2)}`;

            // Next recipients
            const menIds   = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup!=='women'; });
            const womenIds = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup==='women'; });
            const nextMen   = menIds.length   ? getPersonById(menIds[poolRecipientIndex % menIds.length])     : null;
            const nextWomen = womenIds.length ? getPersonById(womenIds[poolRecipientIndexWomen % womenIds.length]) : null;
            document.getElementById('nextRecipient').textContent      = nextMen   ? nextMen.name   : '-';
            document.getElementById('nextRecipientWomen').textContent = nextWomen ? nextWomen.name : '-';

            // Total debt
            let totalDebt = 0;
            getActivePeople().forEach(person => {
                const id = person.id;
                const totalPaid = weeks.reduce((s,w) => s + (w.payments[id]?.thursday||0) + (w.payments[id]?.monthly||0) + (w.payments[id]?.fullMonth||0), 0);
                let expectedWeekly = 0, expectedMonthly = 0;
                const joinedAt = person.joinedWeekIndex ?? 0;
                for (let i = joinedAt; i <= currentWeekIndex; i++) {
                    const r = getRatesForWeek(id, i);
                    expectedWeekly += r.weeklyAmount || 0;
                    if (isMonthlyPaymentDue(weeks[i]?.date)) expectedMonthly += r.monthlyAmount || 0;
                }
                const balance = totalPaid - (expectedWeekly + expectedMonthly);
                if (balance < 0) totalDebt += Math.abs(balance);
            });
            document.getElementById('totalDebt').textContent = `$${totalDebt.toFixed(2)}`;
        }

        function renderSummaryTab() {
            const container = document.getElementById('summaryTableBody');
            container.innerHTML = '';

            let activePeople = getActivePeople();
            if (summarySortMode === 'name') {
                activePeople = [...activePeople].sort((a, b) => a.name.localeCompare(b.name));
            }

            const menIds   = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup!=='women'; });
            const womenIds = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup==='women'; });

            activePeople.forEach((person, displayIdx) => {
                const id = person.id;
                const totalPaid = weeks.reduce((s,w) => s + (w.payments[id]?.thursday||0) + (w.payments[id]?.monthly||0) + (w.payments[id]?.fullMonth||0), 0);

                let expectedWeekly = 0, expectedMonthly = 0;
                const joinedAt = person.joinedWeekIndex ?? 0;
                for (let i = joinedAt; i <= currentWeekIndex; i++) {
                    const r = getRatesForWeek(id, i);
                    expectedWeekly += r.weeklyAmount || 0;
                    if (isMonthlyPaymentDue(weeks[i]?.date)) expectedMonthly += r.monthlyAmount || 0;
                }
                const balance = totalPaid - (expectedWeekly + expectedMonthly);
                const nextPayment = getNextPaymentInfo(id);
                const isWomen = person.profile.poolGroup === 'women';
                const groupIds = isWomen ? womenIds : menIds;
                const groupRecipIdx = isWomen ? poolRecipientIndexWomen : poolRecipientIndex;

                const position = (groupIds.indexOf(id) - (groupRecipIdx % Math.max(groupIds.length,1)) + groupIds.length) % Math.max(groupIds.length,1);
                let payoutDate = new Date();
                const daysUntilFriday = (5 - payoutDate.getDay() + 7) % 7;
                payoutDate.setDate(payoutDate.getDate() + (daysUntilFriday === 0 && payoutDate.getHours() >= 12 ? 7 : daysUntilFriday));
                payoutDate.setDate(payoutDate.getDate() + (position * 7));
                const payoutDateStr = payoutDate.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });

                let statusText = balance >= 0
                    ? `Covered until ${nextPayment.date.toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'})}`
                    : 'Owes';
                const statusColor = balance >= 0 ? '#27ae60' : '#e74c3c';
                const groupColor = isWomen ? '#8e44ad' : '#2980b9';

                const row = document.createElement('div');
                row.className = 'summary-row';
                row.innerHTML = `
                    <div><strong style="color:${groupColor};">${displayIdx + 1}</strong></div>
                    <div>
                        <strong>${person.name}</strong>
                        <div style="font-size:10px; color:${groupColor};">${person.profile.poolGroup || 'men'} ¬∑ ${id}</div>
                    </div>
                    <div>$${totalPaid.toFixed(2)}</div>
                    <div style="color:${statusColor}; font-weight:bold;">${balance >= 0 ? '+' : ''}$${balance.toFixed(2)}</div>
                    <div>
                        <span class="status ${balance >= 0 ? 'paid' : 'unpaid'}" style="background:${statusColor};">${statusText}</span>
                        <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">Next: $${nextPayment.amount.toFixed(2)} due ${nextPayment.date.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})}</div>
                    </div>
                    <div class="projection">${position === 0 ? 'üéØ ' : ''}${payoutDateStr}</div>`;
                container.appendChild(row);
            });
        }

        function renderPayoutsTab() {
            const container = document.getElementById('payoutsContainer');
            container.innerHTML = '';

            const menIds   = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup!=='women'; });
            const womenIds = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup==='women'; });

            const renderGroup = (groupIds, groupLabel, recipientIdx, color) => {
                if (groupIds.length === 0) return;
                const header = document.createElement('h3');
                header.style.cssText = `color:${color}; margin:20px 0 10px;`;
                header.textContent = `${groupLabel} Pool`;
                container.appendChild(header);

                const totalRounds = Math.max(1, Math.ceil(payouts.filter(p => {
                    const person = getPersonById(p.recipientId);
                    return person && (groupLabel === 'Women' ? person.profile.poolGroup === 'women' : person.profile.poolGroup !== 'women');
                }).length / groupIds.length) + 1);

                for (let round = 0; round < totalRounds; round++) {
                    groupIds.forEach((personId, posInGroup) => {
                        const globalIdx = round * groupIds.length + posInGroup;
                        // find existing payout for this person/round
                        const groupPayouts = payouts.filter(p => {
                            const person = getPersonById(p.recipientId);
                            return person && (groupLabel === 'Women' ? person.profile.poolGroup === 'women' : person.profile.poolGroup !== 'women');
                        });
                        const existingPayout = groupPayouts[globalIdx];
                        const person = getPersonById(personId);
                        if (!person) return;
                        const isNext = globalIdx === recipientIdx;

                        const card = document.createElement('div');
                        card.className = `payout-card ${existingPayout?.paid ? 'paid' : 'pending'}`;
                        card.innerHTML = `
                            <div class="payout-header">
                                <div>
                                    <div class="payout-name">${person.name}</div>
                                    <div style="font-size:12px; color:#7f8c8d; margin-top:5px;">Round ${round+1} ¬∑ Position ${posInGroup+1} ¬∑ <span style="color:${color}">${groupLabel}</span></div>
                                </div>
                                <span class="payout-status ${existingPayout?.paid ? 'paid' : 'pending'}">
                                    ${existingPayout?.paid ? '‚úì PAID' : isNext ? '‚≠ê NEXT' : 'PENDING'}
                                </span>
                            </div>
                            <div class="payout-details">
                                <div class="payout-detail"><label>Amount Paid</label>
                                    <input type="number" id="pamt_${groupLabel}_${globalIdx}" value="${existingPayout?.amount||''}" placeholder="0.00" ${!isNext&&!existingPayout?.paid?'disabled':''}></div>
                                <div class="payout-detail"><label>Date Paid</label>
                                    <input type="date" id="pdate_${groupLabel}_${globalIdx}" value="${existingPayout?.date||''}" ${!isNext&&!existingPayout?.paid?'disabled':''}></div>
                                <div class="payout-detail"><label>Notes</label>
                                    <input type="text" id="pnotes_${groupLabel}_${globalIdx}" value="${existingPayout?.notes||''}" placeholder="Optional" ${!isNext&&!existingPayout?.paid?'disabled':''}></div>
                            </div>
                            ${isNext || existingPayout?.paid ? `
                                <div class="payout-actions">
                                    ${!existingPayout?.paid ? `
                                        <button onclick="markPayoutAsPaid('${groupLabel}',${globalIdx},'${personId}')" style="background:#27ae60;">‚úì Mark as Paid</button>
                                    ` : `
                                        <button onclick="updatePayout('${groupLabel}',${globalIdx},'${personId}')" style="background:#3498db;">üíæ Update</button>
                                        <button onclick="deletePayout('${groupLabel}',${globalIdx})" style="background:#e74c3c;">üóëÔ∏è Delete</button>
                                    `}
                                </div>` : ''}`;
                        container.appendChild(card);
                        if (!existingPayout?.paid && globalIdx > recipientIdx) return;
                    });
                }
            };

            renderGroup(menIds,   'Men',   poolRecipientIndex,       '#2980b9');
            renderGroup(womenIds, 'Women', poolRecipientIndexWomen,  '#8e44ad');
        }

        function markPayoutAsPaid(groupLabel, globalIdx, personId) {
            const amount = parseFloat(document.getElementById(`pamt_${groupLabel}_${globalIdx}`).value);
            const date   = document.getElementById(`pdate_${groupLabel}_${globalIdx}`).value;
            const notes  = document.getElementById(`pnotes_${groupLabel}_${globalIdx}`).value;
            if (!amount || !date) { alert('Please enter both amount and date'); return; }

            const person = getPersonById(personId);
            const isWomen = person?.profile?.poolGroup === 'women';

            // Find the correct slot in payouts array for this group
            const groupPayoutsBefore = payouts.filter(p => {
                const pp = getPersonById(p.recipientId);
                return pp && (isWomen ? pp.profile.poolGroup === 'women' : pp.profile.poolGroup !== 'women');
            });
            // Splice into global payouts at right position
            const newPayout = { recipientId: personId, recipientName: person?.name || personId, amount, date, notes, paid: true };
            payouts.push(newPayout);

            payoutHistory.push({
                id: Date.now() + Math.random(),
                recipientId: personId,
                recipientName: person?.name || personId,
                amount, direction: 'paid', date,
                timestamp: new Date().toISOString(), notes
            });

            if (isWomen) poolRecipientIndexWomen++;
            else         poolRecipientIndex++;

            saveData(); updateSummary(); renderPayoutsTab(); renderSummaryTab(); renderTransactionLog();
            alert(`Payout of $${amount} to ${person?.name} recorded!`);

            const phone = phoneNumbers[personId];
            if (phone) {
                if (confirm(`Send WhatsApp notification to ${person?.name} about their $${amount} payout?`)) {
                    const formattedDate = new Date(date).toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
                    const msg = `Hi ${person?.name}! üéâ\n\nGreat news ‚Äî your pool payout of $${parseFloat(amount).toFixed(2)} has been processed on ${formattedDate}.\n\n${notes?'Note: '+notes+'\n\n':''}Thank you for being part of the pool!`;
                    window.open(`https://wa.me/${phone.replace(/[^0-9]/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }
        }

        function updatePayout(groupLabel, globalIdx, personId) {
            const amount = parseFloat(document.getElementById(`pamt_${groupLabel}_${globalIdx}`).value);
            const date   = document.getElementById(`pdate_${groupLabel}_${globalIdx}`).value;
            const notes  = document.getElementById(`pnotes_${groupLabel}_${globalIdx}`).value;
            if (!amount || !date) { alert('Please enter both amount and date'); return; }
            const person = getPersonById(personId);
            const isWomen = person?.profile?.poolGroup === 'women';
            // find correct entry in payouts
            let count = 0;
            for (let i = 0; i < payouts.length; i++) {
                const pp = getPersonById(payouts[i].recipientId);
                const inGroup = pp && (isWomen ? pp.profile.poolGroup === 'women' : pp.profile.poolGroup !== 'women');
                if (inGroup) {
                    if (count === globalIdx) { payouts[i] = { ...payouts[i], amount, date, notes }; break; }
                    count++;
                }
            }
            saveData(); renderPayoutsTab(); renderTransactionLog();
            alert('Payout updated!');
        }

        function deletePayout(groupLabel, globalIdx) {
            if (!confirm('Delete this payout record?')) return;
            const isWomen = groupLabel === 'Women';
            let count = 0;
            for (let i = 0; i < payouts.length; i++) {
                const pp = getPersonById(payouts[i].recipientId);
                const inGroup = pp && (isWomen ? pp.profile.poolGroup === 'women' : pp.profile.poolGroup !== 'women');
                if (inGroup) {
                    if (count === globalIdx) { payouts.splice(i, 1); break; }
                    count++;
                }
            }
            if (isWomen) poolRecipientIndexWomen = payouts.filter(p => { const pp=getPersonById(p.recipientId); return pp?.profile?.poolGroup==='women'&&p.paid; }).length;
            else         poolRecipientIndex      = payouts.filter(p => { const pp=getPersonById(p.recipientId); return pp?.profile?.poolGroup!=='women'&&p.paid; }).length;
            saveData(); updateSummary(); renderPayoutsTab(); renderSummaryTab(); renderTransactionLog();
        }

        function renderTransactionLog() {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '';
            
            const allTransactions = [
                ...paymentHistory.map(p => ({
                    ...p,
                    displayType: p.type === 'thursday' ? 'Thursday Pool' : 
                                 p.type === 'monthly' ? 'Monthly Payment' : 'Full Month',
                    direction: 'received'
                })),
                ...payoutHistory.map(p => ({
                    ...p,
                    displayType: 'Pool Payout',
                    entrantName: p.recipientName,
                    direction: 'paid'
                }))
            ];
            
            allTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No transactions yet</p>';
                return;
            }
            
            allTransactions.forEach(transaction => {
                const div = document.createElement('div');
                div.className = `transaction-item ${transaction.direction}`;
                
                const timestamp = new Date(transaction.timestamp).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                div.innerHTML = `
                    <div class="transaction-date">${timestamp}</div>
                    <div>
                        <span class="transaction-type">${transaction.displayType}</span>
                    </div>
                    <div>
                        <strong>${transaction.direction === 'received' ? 'From' : 'To'}:</strong> ${transaction.entrantName}
                        ${transaction.notes ? `<br><small style="color: #7f8c8d;">${transaction.notes}</small>` : ''}
                    </div>
                    <div class="transaction-amount ${transaction.direction === 'received' ? 'positive' : 'negative'}">
                        ${transaction.direction === 'received' ? '+' : '-'}$${transaction.amount.toFixed(2)}
                    </div>
                    <div style="text-align: right;">
                        <span style="font-size: 11px; color: #7f8c8d;">
                            ${transaction.direction === 'received' ? 'üì• Received' : 'üì§ Paid Out'}
                        </span>
                    </div>
                    <div class="transaction-actions">
                        <button class="edit" onclick="editTransaction('${transaction.id}')">‚úèÔ∏è</button>
                        <button class="delete" onclick="deleteTransaction('${transaction.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function editTransaction(id) {
            const transaction = [...paymentHistory, ...payoutHistory].find(t => t.id === id);
            if (!transaction) return;
            
            const content = document.getElementById('editTransactionContent');
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Amount</label>
                    <input type="number" id="editAmount" value="${transaction.amount}" step="0.01" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Date/Time</label>
                    <input type="datetime-local" id="editTimestamp" 
                           value="${new Date(transaction.timestamp).toISOString().slice(0,16)}"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                ${transaction.notes !== undefined ? `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Notes</label>
                    <input type="text" id="editNotes" value="${transaction.notes || ''}"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                ` : ''}
                <button onclick="saveTransactionEdit('${id}')" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Save Changes
                </button>
            `;
            
            document.getElementById('editTransactionModal').style.display = 'block';
        }

        function saveTransactionEdit(id) {
            const newAmount = parseFloat(document.getElementById('editAmount').value);
            const newTimestamp = new Date(document.getElementById('editTimestamp').value).toISOString();
            const notesInput = document.getElementById('editNotes');
            const newNotes = notesInput ? notesInput.value : undefined;
            
            let transaction = paymentHistory.find(t => t.id === id);
            if (transaction) {
                transaction.amount = newAmount;
                transaction.timestamp = newTimestamp;
            } else {
                transaction = payoutHistory.find(t => t.id === id);
                if (transaction) {
                    transaction.amount = newAmount;
                    transaction.timestamp = newTimestamp;
                    if (newNotes !== undefined) transaction.notes = newNotes;
                }
            }
            
            saveData();
            renderTransactionLog();
            closeModal('editTransactionModal');
        }

        function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            paymentHistory = paymentHistory.filter(t => t.id !== id);
            payoutHistory = payoutHistory.filter(t => t.id !== id);
            
            saveData();
            renderTransactionLog();
        }

        function exportTransactionsToExcel() {
            const allTransactions = [
                ...paymentHistory.map(p => ({...p, displayType: p.type==='thursday'?'Weekly Pool':p.type==='monthly'?'Monthly Payment':'Full Month', direction:'received'})),
                ...payoutHistory.map(p => ({...p, displayType:'Pool Payout', entrantName:p.recipientName, direction:'paid'}))
            ].sort((a,b) => new Date(a.timestamp)-new Date(b.timestamp));

            const data = allTransactions.map(t => ({'Date':formatDateMMDDYYYY(t.timestamp),'Time':new Date(t.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),'Type':t.displayType,'Direction':t.direction==='received'?'Received':'Paid Out','ID':t.entrantId||t.recipientId||'','Person':t.entrantName,'Amount':t.amount,'Notes':t.notes||''}));
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, `transactions_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToExcel() {
            let investmentTotal=0, beitHobTotal=0, poolMenTotal=0, poolWomenTotal=0;
            weeks.forEach(week => {
                getActivePeople().forEach(person => {
                    const id = person.id;
                    const payment = week.payments[id] || {};
                    const rates = week.rateSnapshots?.[id] || person.profile;
                    const monthly = payment.monthly||0, fullMonth = payment.fullMonth||0, weekly = payment.thursday||0;
                    const isWomen = rates.poolGroup==='women';
                    if (monthly>0 && rates.monthlyAmount>0) { const r=monthly/rates.monthlyAmount; investmentTotal+=rates.monthlyToInvestment*r; beitHobTotal+=rates.monthlyToBeitHob*r; }
                    if (fullMonth>0) { const mp=Math.min(fullMonth,rates.monthlyAmount||0); const wp=fullMonth-mp; if(mp>0&&rates.monthlyAmount>0){const r=mp/rates.monthlyAmount;investmentTotal+=rates.monthlyToInvestment*r;beitHobTotal+=rates.monthlyToBeitHob*r;} if(wp>0){isWomen?(poolWomenTotal+=wp):(poolMenTotal+=wp);} }
                    isWomen?(poolWomenTotal+=weekly):(poolMenTotal+=weekly);
                });
            });
            let beitHobExp=0, poolMenExp=0, poolWomenExp=0, investExp=0;
            expenseEntries.forEach(e => { if(e.cashBox==='beit-hob')beitHobExp+=e.amountUSD; else if(e.cashBox==='pool')poolMenExp+=e.amountUSD; else if(e.cashBox==='pool-women')poolWomenExp+=e.amountUSD; });
            investmentEntries.forEach(i => { investExp+=i.amountUSD; });
            payoutHistory.forEach(p => { const pp=getPersonById(p.recipientId); (pp?.profile?.poolGroup==='women')?(poolWomenExp+=p.amount):(poolMenExp+=p.amount); });

            const summaryData = [
                ['MONEY POOL SUMMARY'], ['Export Date', new Date().toLocaleString()], [],
                ['CASH BOXES (NET)'], ['','Gross','Expenses/Payouts','NET'],
                ['Investment', investmentTotal, investExp, investmentTotal-investExp],
                ['Beit Hob', beitHobTotal, beitHobExp, beitHobTotal-beitHobExp],
                ['Pool (Men)', poolMenTotal, poolMenExp, poolMenTotal-poolMenExp],
                ['Pool (Women)', poolWomenTotal, poolWomenExp, poolWomenTotal-poolWomenExp],
                [], ['INDIVIDUAL SUMMARY']
            ];

            const individualData = getActivePeople().map((person, idx) => {
                const id = person.id;
                const totalPaid = weeks.reduce((s,w) => s+(w.payments[id]?.thursday||0)+(w.payments[id]?.monthly||0)+(w.payments[id]?.fullMonth||0),0);
                let expW=0, expM=0;
                for(let i=0;i<=currentWeekIndex;i++){const r=getRatesForWeek(id,i);expW+=r.weeklyAmount||0;if(isMonthlyPaymentDue(weeks[i]?.date))expM+=r.monthlyAmount||0;}
                const balance=totalPaid-(expW+expM);
                const nextPayment=getNextPaymentInfo(id);
                return {'#':idx+1,'ID':id,'Name':person.name,'Pool Group':person.profile.poolGroup,'Weekly Rate':person.profile.weeklyAmount,'Monthly Rate':person.profile.monthlyAmount,'Total Paid':totalPaid,'Balance':balance,'Next Payment Date':formatDateMMDDYYYY(nextPayment.date),'Next Payment Amount':nextPayment.amount};
            });

            const paymentsData = paymentHistory.map(p => ({'Date':formatDateMMDDYYYY(p.timestamp),'Time':new Date(p.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),'ID':p.entrantId,'Name':p.entrantName,'Type':p.type==='thursday'?'Weekly Pool':p.type==='monthly'?'Monthly':'Full Month','Amount':p.amount,'Week Date':p.weekDate}));
            const payoutsData = payoutHistory.map(p => ({'Date':formatDateMMDDYYYY(p.timestamp),'Time':new Date(p.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),'ID':p.recipientId,'Recipient':p.recipientName,'Amount':p.amount,'Notes':p.notes||''}));

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.sheet_add_json(ws1, individualData, { origin: -1 });
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');
            if (paymentsData.length>0) { const ws2=XLSX.utils.json_to_sheet(paymentsData); XLSX.utils.book_append_sheet(wb,ws2,'Payments Received'); }
            if (payoutsData.length>0)  { const ws3=XLSX.utils.json_to_sheet(payoutsData);  XLSX.utils.book_append_sheet(wb,ws3,'Payouts Made'); }
            if (expenseEntries.length>0) { const ws4=XLSX.utils.json_to_sheet(expenseEntries.map(e=>({'Date':e.date,'Cash Box':e.cashBox,'Amount USD':e.amountUSD,'Description':e.description}))); XLSX.utils.book_append_sheet(wb,ws4,'Expenses'); }
            if (investmentEntries.length>0) { const ws5=XLSX.utils.json_to_sheet(investmentEntries.map(e=>({'Date':e.date,'Amount USD':e.amountUSD,'Description':e.description}))); XLSX.utils.book_append_sheet(wb,ws5,'Investments'); }
            XLSX.writeFile(wb, `money_pool_report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        async function saveData() {
            const data = {
                people, peopleOrder, _nextPersonSeq,
                deletedPeopleIds: [...deletedPeopleIds],
                weeks, currentWeekIndex,
                poolRecipientIndex, poolRecipientIndexWomen,
                payouts, phoneNumbers, paymentHistory, payoutHistory,
                expenseEntries, investmentEntries, exchangeRate
            };
            localStorage.setItem('moneyPoolData', JSON.stringify(data));
            await saveToGithub(data);
        }

        async function loadData() {
            // Try GitHub first (most up-to-date across devices)
            const token = getGhToken();
            if (token) {
                await loadFromGithub();
                return;
            }
            // Fall back to localStorage
            const saved = localStorage.getItem('moneyPoolData');
            if (saved) {
                applyData(JSON.parse(saved));
            }
        }

        function exportToFile() {
            const data = {
                people, peopleOrder, _nextPersonSeq,
                deletedPeopleIds: [...deletedPeopleIds],
                weeks, currentWeekIndex,
                poolRecipientIndex, poolRecipientIndexWomen,
                payouts, phoneNumbers, paymentHistory, payoutHistory,
                expenseEntries, investmentEntries, exchangeRate,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `money_pool_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        }

        function importFromFile() {
            document.getElementById('importFileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    applyData(data);
                    refreshAllViews();
                    saveData();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing file. Please check the file format.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function showManageEntrants() {
            tempPeople = getActivePeople().map(p => ({ ...p, profile: { ...p.profile } }));
            renderEntrantsList();
            document.getElementById('manageModal').style.display = 'block';
        }

        let tempPeople = [];
        let draggedIndex = null;

        function renderEntrantsList() {
            const container = document.getElementById('entrantsList');
            container.innerHTML = '';
            tempPeople.forEach((person, index) => {
                const profile = person.profile;
                const isWomen = profile.poolGroup === 'women';
                const groupColor = isWomen ? '#8e44ad' : '#2980b9';
                const div = document.createElement('div');
                div.className = 'entrant-item';
                div.style.flexDirection = 'column';
                div.style.cursor = 'default';
                div.dataset.index = index;
                div.innerHTML = `
                    <div style="display:flex; align-items:center; width:100%; gap:8px;">
                        <span class="drag-handle" draggable="true"
                              ondragstart="handleDragStart(event,${index})"
                              ondragover="handleDragOver(event)"
                              ondrop="handleDrop(event,${index})"
                              ondragend="handleDragEnd(event)"
                              ondragenter="handleDragEnter(event,${index})"
                              ondragleave="handleDragLeave(event)">‚ò∞</span>
                        <span class="entrant-number" style="background:${groupColor};">${index + 1}</span>
                        <input type="text" class="entrant-name-input" value="${person.name}"
                               onchange="updateTempPersonName(${index}, this.value)" placeholder="Enter name">
                        <span style="font-size:10px; color:#95a5a6; white-space:nowrap;">ID: ${person.id}</span>
                        <button class="profile-toggle" onclick="toggleProfile(${index})">‚ñ∂ Rates</button>
                        <button class="remove-entrant" onclick="removeEntrant(${index})">√ó</button>
                    </div>
                    <div class="profile-section" id="profile_${index}">
                        <div class="profile-row">
                            <label>Start Week</label>
                            <select onchange="updateTempProfile(${index},'joinedWeekIndex',+this.value)" style="padding:5px 7px; border:1px solid #bdc3c7; border-radius:3px; font-size:13px; max-width:200px;">
                                ${weeks.map((w,wi) => `<option value="${wi}" ${(person.joinedWeekIndex??0)===wi?'selected':''}>${wi===0?'Beginning ¬∑ ':''}Week ${wi+1} ¬∑ ${formatDate(w.date)}</option>`).join('')}
                            </select>
                            <span class="split-hint">when they started contributing</span>
                        </div>
                        <div class="profile-row">
                            <label>Pool Group</label>
                            <select onchange="updateTempProfile(${index},'poolGroup',this.value)">
                                <option value="men"   ${profile.poolGroup!=='women'?'selected':''}>Men</option>
                                <option value="women" ${profile.poolGroup==='women'?'selected':''}>Women</option>
                            </select>
                        </div>
                        <div class="profile-row">
                            <label>Weekly amount</label>
                            <input type="number" value="${profile.weeklyAmount}" min="0" step="0.01"
                                   onchange="updateTempProfile(${index},'weeklyAmount',+this.value)">
                            <span class="split-hint">$/week ‚Üí pool</span>
                        </div>
                        <div class="profile-row">
                            <label>Monthly amount</label>
                            <input type="number" value="${profile.monthlyAmount}" min="0" step="0.01"
                                   onchange="updateTempProfile(${index},'monthlyAmount',+this.value); autoFillBeitHob(${index})">
                            <span class="split-hint">$/month total</span>
                        </div>
                        <div class="profile-row">
                            <label>‚Üí Investment</label>
                            <input type="number" value="${profile.monthlyToInvestment}" min="0" step="0.01"
                                   onchange="updateTempProfile(${index},'monthlyToInvestment',+this.value); autoFillBeitHob(${index})">
                            <span class="split-hint">of monthly</span>
                        </div>
                        <div class="profile-row">
                            <label>‚Üí Beit Hob</label>
                            <input type="number" value="${profile.monthlyToBeitHob}" min="0" step="0.01"
                                   id="bhInput_${index}"
                                   onchange="updateTempProfile(${index},'monthlyToBeitHob',+this.value); updateSplitHint(${index})">
                            <span class="split-hint" id="splitHint_${index}" style="color:${Math.abs(profile.monthlyToInvestment+profile.monthlyToBeitHob-profile.monthlyAmount)<0.01?'#27ae60':'#e74c3c'};">
                                ${Math.abs(profile.monthlyToInvestment+profile.monthlyToBeitHob-profile.monthlyAmount)<0.01?'‚úì splits match':'‚ö† splits don\'t match'}
                            </span>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
        }

        function toggleProfile(index) {
            const el = document.getElementById(`profile_${index}`);
            if (el) el.classList.toggle('open');
        }

        function autoFillBeitHob(index) {
            const p = tempPeople[index].profile;
            p.monthlyToBeitHob = Math.max(0, parseFloat((p.monthlyAmount - p.monthlyToInvestment).toFixed(2)));
            const input = document.getElementById(`bhInput_${index}`);
            if (input) input.value = p.monthlyToBeitHob;
            updateSplitHint(index);
        }

        function updateSplitHint(index) {
            const p = tempPeople[index]?.profile;
            const hint = document.getElementById(`splitHint_${index}`);
            if (!hint || !p) return;
            const ok = Math.abs(p.monthlyToInvestment + p.monthlyToBeitHob - p.monthlyAmount) < 0.01;
            hint.textContent = ok ? '‚úì splits match' : '‚ö† splits don\'t match';
            hint.style.color = ok ? '#27ae60' : '#e74c3c';
        }

        function updateTempPersonName(index, newName) {
            if (tempPeople[index]) tempPeople[index].name = newName || `Person ${index + 1}`;
        }

        function updateTempProfile(index, field, value) {
            if (!tempPeople[index]) return;
            if (field === 'joinedWeekIndex') {
                tempPeople[index].joinedWeekIndex = parseInt(value);
            } else {
                tempPeople[index].profile[field] = value;
                updateSplitHint(index);
            }
        }

        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.closest('.entrant-item')?.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }

        function handleDragEnter(e, index) {
            if (index !== draggedIndex) e.target.closest('.entrant-item')?.classList.add('drag-over');
        }

        function handleDragLeave(e) { e.target.closest('.entrant-item')?.classList.remove('drag-over'); }

        function handleDrop(e, dropIndex) {
            e.stopPropagation();
            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                const dragged = tempPeople[draggedIndex];
                tempPeople.splice(draggedIndex, 1);
                tempPeople.splice(dropIndex, 0, dragged);
                renderEntrantsList();
            }
            return false;
        }

        function handleDragEnd(e) {
            e.target.closest('.entrant-item')?.classList.remove('dragging');
            document.querySelectorAll('.entrant-item').forEach(i => i.classList.remove('drag-over'));
            draggedIndex = null;
        }

        function addNewEntrant() {
            const id = generatePersonId();
            const newPerson = { id, name: `Person ${tempPeople.length + 1}`, profile: defaultProfile('men'), deletedAt: null, joinedWeekIndex: currentWeekIndex };
            tempPeople.push(newPerson);
            renderEntrantsList();
            setTimeout(() => toggleProfile(tempPeople.length - 1), 30);
        }

        function removeEntrant(index) {
            if (tempPeople.length <= 1) { alert('You must have at least one person in the pool!'); return; }
            const person = tempPeople[index];
            if (confirm(`Remove ${person.name}? Their payment history will be preserved.`)) {
                tempPeople.splice(index, 1);
                renderEntrantsList();
            }
        }

        function saveEntrantsAndClose() {
            for (const p of tempPeople) {
                const diff = Math.abs(p.profile.monthlyToInvestment + p.profile.monthlyToBeitHob - p.profile.monthlyAmount);
                if (diff > 0.01) {
                    alert(`‚ö† ${p.name}'s monthly split doesn't add up to $${p.profile.monthlyAmount}. Please fix before saving.`);
                    return;
                }
            }

            const newIds = new Set(tempPeople.map(p => p.id));
            people.forEach(p => {
                if (!p.deletedAt && !newIds.has(p.id)) {
                    p.deletedAt = new Date().toISOString();
                    deletedPeopleIds.add(p.id);
                }
            });

            tempPeople.forEach(tp => {
                const existing = people.find(p => p.id === tp.id);
                if (existing) {
                    existing.name             = tp.name;
                    existing.profile          = { ...tp.profile };
                    existing.deletedAt        = null;
                    existing.joinedWeekIndex  = tp.joinedWeekIndex ?? 0;
                } else {
                    people.push({ ...tp });
                }
            });

            peopleOrder = tempPeople.map(p => p.id);

            weeks.forEach(week => {
                if (!week.rateSnapshots) week.rateSnapshots = {};
                tempPeople.forEach(person => {
                    if (!week.payments[person.id]) week.payments[person.id] = { thursday:0, monthly:0, fullMonth:0 };
                    if (!week.rateSnapshots[person.id]) week.rateSnapshots[person.id] = { ...person.profile };
                });
            });

            const menIds   = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup!=='women'; });
            const womenIds = peopleOrder.filter(id => { const p=getPersonById(id); return p&&!p.deletedAt&&p.profile.poolGroup==='women'; });
            if (menIds.length   && poolRecipientIndex      >= menIds.length)   poolRecipientIndex = 0;
            if (womenIds.length && poolRecipientIndexWomen >= womenIds.length) poolRecipientIndexWomen = 0;

            closeModal('manageModal');
            renderTable();
            updateSummary();
            renderSummaryTab();
            renderPayoutsTab();
            saveData();
            alert('Changes saved successfully!');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.removeItem('moneyPoolData');
                people = []; peopleOrder = []; _nextPersonSeq = 1; deletedPeopleIds = new Set();
                weeks = []; currentWeekIndex = 0;
                poolRecipientIndex = 0; poolRecipientIndexWomen = 0;
                payouts = []; phoneNumbers = {};
                paymentHistory = []; payoutHistory = [];
                expenseEntries = []; investmentEntries = [];
                exchangeRate = 89500; _ghFileSha = null;
                init();
            }
        }

        // ============================
        // EXCHANGE RATE SETTINGS
        // ============================

        function saveExchangeRate() {
            const newRate = parseFloat(document.getElementById('exchangeRateInput').value);
            if (!newRate || newRate <= 0) {
                alert('Please enter a valid exchange rate.');
                return;
            }
            exchangeRate = newRate;
            document.getElementById('currentRateDisplay').textContent = exchangeRate.toLocaleString();
            saveData();
            const msg = document.getElementById('rateSavedMsg');
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        }

        // ============================
        // EXPENSES
        // ============================

        function updateExpenseAmountLabel() {
            const currency = document.getElementById('expCurrency').value;
            document.getElementById('expAmountLabel').textContent = currency === 'LBP' ? 'Amount (LBP)' : 'Amount (USD)';
        }

        function addExpense() {
            const cashBox = document.getElementById('expCashBox').value;
            const currency = document.getElementById('expCurrency').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            const date = document.getElementById('expDate').value;
            const description = document.getElementById('expDescription').value.trim();

            if (!amount || amount <= 0) { alert('Please enter a valid amount.'); return; }
            if (!date) { alert('Please select a date.'); return; }
            if (!description) { alert('Please enter a description.'); return; }

            const amountUSD = currency === 'LBP' ? amount / exchangeRate : amount;

            if (editingExpenseId !== null) {
                // Update existing
                const idx = expenseEntries.findIndex(e => e.id === editingExpenseId);
                if (idx !== -1) {
                    expenseEntries[idx] = {
                        ...expenseEntries[idx],
                        cashBox, currency, amount, amountUSD, date, description,
                        exchangeRate: currency === 'LBP' ? exchangeRate : null
                    };
                }
                editingExpenseId = null;
                document.getElementById('expEditNote').style.display = 'none';
            } else {
                expenseEntries.push({
                    id: Date.now() + Math.random(),
                    cashBox, currency, amount, amountUSD, date, description,
                    timestamp: new Date().toISOString(),
                    exchangeRate: currency === 'LBP' ? exchangeRate : null
                });
            }

            // Reset form
            document.getElementById('expAmount').value = '';
            document.getElementById('expDescription').value = '';
            document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expCurrency').value = 'USD';
            updateExpenseAmountLabel();

            saveData();
            updateSummary();
            renderExpensesList();
        }

        function editExpense(id) {
            const entry = expenseEntries.find(e => e.id === id);
            if (!entry) return;
            editingExpenseId = id;
            document.getElementById('expCashBox').value = entry.cashBox;
            document.getElementById('expCurrency').value = entry.currency;
            document.getElementById('expAmount').value = entry.amount;
            document.getElementById('expDate').value = entry.date;
            document.getElementById('expDescription').value = entry.description;
            updateExpenseAmountLabel();
            document.getElementById('expEditNote').style.display = 'inline';
            document.getElementById('expensesTab').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cancelExpenseEdit() {
            editingExpenseId = null;
            document.getElementById('expAmount').value = '';
            document.getElementById('expDescription').value = '';
            document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expCurrency').value = 'USD';
            updateExpenseAmountLabel();
            document.getElementById('expEditNote').style.display = 'none';
        }

        function deleteExpense(id) {
            if (!confirm('Delete this expense entry?')) return;
            expenseEntries = expenseEntries.filter(e => e.id !== id);
            saveData();
            updateSummary();
            renderExpensesList();
        }

        function setExpenseSort(mode) {
            expenseSortMode = mode;
            document.querySelectorAll('[id^="expSort"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`expSort${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            renderExpensesList();
        }

        function renderExpensesList() {
            const container = document.getElementById('expensesList');
            if (!container) return;
            container.innerHTML = '';

            let sorted = [...expenseEntries];
            if (expenseSortMode === 'date') sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (expenseSortMode === 'desc') sorted.sort((a, b) => a.description.localeCompare(b.description));
            else if (expenseSortMode === 'amount') sorted.sort((a, b) => b.amountUSD - a.amountUSD);
            else if (expenseSortMode === 'box') sorted.sort((a, b) => a.cashBox.localeCompare(b.cashBox));

            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:30px;">No expenses recorded yet</p>';
                return;
            }

            // Totals
            const totalBeitHob = expenseEntries.filter(e => e.cashBox === 'beit-hob').reduce((s, e) => s + e.amountUSD, 0);
            const totalPool = expenseEntries.filter(e => e.cashBox === 'pool').reduce((s, e) => s + e.amountUSD, 0);
            const totalAll = totalBeitHob + totalPool;
            const totalsDiv = document.createElement('div');
            totalsDiv.style.cssText = 'padding:10px 20px; background:#f8f9fa; border-bottom:1px solid #ecf0f1; font-size:13px; display:flex; gap:20px; flex-wrap:wrap;';
            totalsDiv.innerHTML = `<span><strong>Total Expenses:</strong> $${totalAll.toFixed(2)}</span>
                <span style="color:#e74c3c">Beit Hob: $${totalBeitHob.toFixed(2)}</span>
                <span style="color:#3498db">Pool: $${totalPool.toFixed(2)}</span>`;
            container.appendChild(totalsDiv);

            sorted.forEach(entry => {
                const boxClass = entry.cashBox === 'beit-hob' ? 'beit-hob-expense' : 'pool-expense';
                const boxLabel = entry.cashBox === 'beit-hob' ? 'Beit Hob' : 'Pool';
                const boxTagClass = entry.cashBox === 'beit-hob' ? 'beit-hob' : 'pool';
                const originalStr = entry.currency === 'LBP'
                    ? `${entry.amount.toLocaleString()} LBP (rate: ${entry.exchangeRate?.toLocaleString()})`
                    : `$${entry.amount.toFixed(2)} USD`;

                const div = document.createElement('div');
                div.className = `expense-item ${boxClass}`;
                div.innerHTML = `
                    <div style="font-size:13px; color:#2c3e50;">${entry.date}</div>
                    <div style="font-weight:bold; color:#e74c3c;">$${entry.amountUSD.toFixed(2)}</div>
                    <div><span class="cashbox-tag ${boxTagClass}">${boxLabel}</span></div>
                    <div style="font-size:13px;">${entry.description}</div>
                    <div style="font-size:11px; color:#7f8c8d;">${originalStr}</div>
                    <div class="transaction-actions">
                        <button class="edit" onclick="editExpense(${JSON.stringify(entry.id)})">‚úèÔ∏è</button>
                        <button class="delete" onclick="deleteExpense(${JSON.stringify(entry.id)})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ============================
        // INVESTMENTS
        // ============================

        function updateInvestmentAmountLabel() {
            const currency = document.getElementById('invCurrency').value;
            document.getElementById('invAmountLabel').textContent = currency === 'LBP' ? 'Amount (LBP)' : 'Amount (USD)';
        }

        function addInvestment() {
            const currency = document.getElementById('invCurrency').value;
            const amount = parseFloat(document.getElementById('invAmount').value);
            const date = document.getElementById('invDate').value;
            const description = document.getElementById('invDescription').value.trim();

            if (!amount || amount <= 0) { alert('Please enter a valid amount.'); return; }
            if (!date) { alert('Please select a date.'); return; }
            if (!description) { alert('Please enter a description.'); return; }

            const amountUSD = currency === 'LBP' ? amount / exchangeRate : amount;

            if (editingInvestmentId !== null) {
                const idx = investmentEntries.findIndex(e => e.id === editingInvestmentId);
                if (idx !== -1) {
                    investmentEntries[idx] = {
                        ...investmentEntries[idx],
                        currency, amount, amountUSD, date, description,
                        exchangeRate: currency === 'LBP' ? exchangeRate : null
                    };
                }
                editingInvestmentId = null;
                document.getElementById('invEditNote').style.display = 'none';
            } else {
                investmentEntries.push({
                    id: Date.now() + Math.random(),
                    currency, amount, amountUSD, date, description,
                    timestamp: new Date().toISOString(),
                    exchangeRate: currency === 'LBP' ? exchangeRate : null
                });
            }

            document.getElementById('invAmount').value = '';
            document.getElementById('invDescription').value = '';
            document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invCurrency').value = 'USD';
            updateInvestmentAmountLabel();

            saveData();
            updateSummary();
            renderInvestmentsList();
        }

        function editInvestment(id) {
            const entry = investmentEntries.find(e => e.id === id);
            if (!entry) return;
            editingInvestmentId = id;
            document.getElementById('invCurrency').value = entry.currency;
            document.getElementById('invAmount').value = entry.amount;
            document.getElementById('invDate').value = entry.date;
            document.getElementById('invDescription').value = entry.description;
            updateInvestmentAmountLabel();
            document.getElementById('invEditNote').style.display = 'inline';
            document.getElementById('investmentsTab').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cancelInvestmentEdit() {
            editingInvestmentId = null;
            document.getElementById('invAmount').value = '';
            document.getElementById('invDescription').value = '';
            document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invCurrency').value = 'USD';
            updateInvestmentAmountLabel();
            document.getElementById('invEditNote').style.display = 'none';
        }

        function deleteInvestment(id) {
            if (!confirm('Delete this investment entry?')) return;
            investmentEntries = investmentEntries.filter(e => e.id !== id);
            saveData();
            updateSummary();
            renderInvestmentsList();
        }

        function setInvestmentSort(mode) {
            investmentSortMode = mode;
            document.querySelectorAll('[id^="invSort"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`invSort${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            renderInvestmentsList();
        }

        function renderInvestmentsList() {
            const container = document.getElementById('investmentsList');
            if (!container) return;
            container.innerHTML = '';

            let sorted = [...investmentEntries];
            if (investmentSortMode === 'date') sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (investmentSortMode === 'desc') sorted.sort((a, b) => a.description.localeCompare(b.description));
            else if (investmentSortMode === 'amount') sorted.sort((a, b) => b.amountUSD - a.amountUSD);

            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:30px;">No investments recorded yet</p>';
                return;
            }

            const totalUSD = investmentEntries.reduce((s, e) => s + e.amountUSD, 0);
            const totalsDiv = document.createElement('div');
            totalsDiv.style.cssText = 'padding:10px 20px; background:#f8f9fa; border-bottom:1px solid #ecf0f1; font-size:13px;';
            totalsDiv.innerHTML = `<strong>Total Invested:</strong> $${totalUSD.toFixed(2)}`;
            container.appendChild(totalsDiv);

            sorted.forEach(entry => {
                const originalStr = entry.currency === 'LBP'
                    ? `${entry.amount.toLocaleString()} LBP (rate: ${entry.exchangeRate?.toLocaleString()})`
                    : `$${entry.amount.toFixed(2)} USD`;

                const div = document.createElement('div');
                div.className = 'expense-item investment-expense';
                div.style.gridTemplateColumns = '140px 90px 1fr 130px 80px';
                div.innerHTML = `
                    <div style="font-size:13px; color:#2c3e50;">${entry.date}</div>
                    <div style="font-weight:bold; color:#9b59b6;">$${entry.amountUSD.toFixed(2)}</div>
                    <div style="font-size:13px;">${entry.description}</div>
                    <div style="font-size:11px; color:#7f8c8d;">${originalStr}</div>
                    <div class="transaction-actions">
                        <button class="edit" onclick="editInvestment(${JSON.stringify(entry.id)})">‚úèÔ∏è</button>
                        <button class="delete" onclick="deleteInvestment(${JSON.stringify(entry.id)})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>
</html>
